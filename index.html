<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCU S.H.I.E.L.D. Complete Database</title>
    <style>
        :root {
            --bg-color: #050505;
            --font-family: 'Courier New', monospace;
            
            /* Phase Colors */
            --p1-bg: #001233; --p1-border: #007BFF; /* Space */
            --p2-bg: #330000; --p2-border: #DC3545; /* Reality */
            --p3-bg: #002200; --p3-border: #28A745; /* Time */
            --p4-bg: #220033; --p4-border: #9370DB; /* Power/Multiverse */
            --p5-bg: #331A00; --p5-border: #FF8C00; /* Soul/Doomsday Build */
            --p6-bg: #003333; --p6-border: #00FFFF; /* Mind/Secret Wars (Cyan/Tech) */
            
            /* Specific Types */
            --shows-bg: #2b1d00; --shows-border: #FFC107; /* Gold */
            --movie-bg: rgba(15, 15, 15, 0.9); --movie-border: #555555; 
            --postcredit-bg: rgba(0, 43, 54, 0.9); --postcredit-border: #17A2B8;
            
            /* Core */
            --core-red: #E23636;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #111 0%, #000 100%);
            overflow: hidden;
            font-family: var(--font-family);
            color: white;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* The Infinite Canvas */
        #viewport {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; cursor: grab; z-index: 1;
        }
        #viewport:active { cursor: grabbing; }

        #world { position: absolute; top: 0; left: 0; transform-origin: 0 0; }

        /* Cosmic Stars Background Effect */
        #stars {
            position: absolute; top: -5000px; left: -5000px;
            width: 20000px; height: 20000px;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 160px 120px, #ddd, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 250px 250px;
            z-index: 0; opacity: 0.3; pointer-events: none;
        }

        svg#connections {
            position: absolute; top: 0; left: 0;
            width: 10000px; height: 10000px;
            pointer-events: none; z-index: 1;
        }

        /* Node Styling - Glassmorphism */
        .node {
            position: absolute;
            width: 260px;
            padding: 15px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            background: var(--movie-bg);
            border: 2px solid var(--movie-border);
            transition: box-shadow 0.2s ease, filter 0.2s ease, transform 0.2s ease;
            cursor: pointer; box-sizing: border-box;
            z-index: 10; border-radius: 8px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            /* Center the node exactly on its coordinates */
            transform: translate(-50%, -50%);
        }

        /* Hover Effect */
        .node:hover, .node:active { 
            z-index: 9999 !important; 
            filter: brightness(1.3);
            /* Maintain centering while scaling */
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        }

        .node h3 {
            margin: 0 0 8px 0; font-size: 14px;
            pointer-events: none; text-transform: uppercase; letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            line-height: 1.3;
        }

        .node ul {
            text-align: left; padding-left: 18px; margin: 0;
            font-size: 12px; line-height: 1.4;
            display: none; pointer-events: none; color: #ddd;
        }
        
        .node.expanded ul { display: block; }

        /* Perfect Circle Core Hub */
        .core-hub {
            width: 350px; height: 350px; 
            min-width: 350px; min-height: 350px; 
            border-radius: 50% !important;
            aspect-ratio: 1 / 1; 
            flex-shrink: 0;
            background: #000; border: 6px solid var(--core-red);
            box-shadow: 0 0 60px var(--core-red), inset 0 0 40px var(--core-red);
            z-index: 50; display: flex; justify-content: center; align-items: center;
        }
        .core-hub h1 {
            color: #FFF; text-shadow: 0 0 10px #FFF, 0 0 20px var(--core-red);
            font-size: 26px; text-transform: uppercase; letter-spacing: 2px; margin: 0;
        }

        /* Node Colors */
        .p1 { background: rgba(0,18,51,0.9); border-color: var(--p1-border); box-shadow: 0 0 15px var(--p1-border); }
        .p2 { background: rgba(51,0,0,0.9); border-color: var(--p2-border); box-shadow: 0 0 15px var(--p2-border); }
        .p3 { background: rgba(0,34,0,0.9); border-color: var(--p3-border); box-shadow: 0 0 15px var(--p3-border); }
        .p4 { background: rgba(34,0,51,0.9); border-color: var(--p4-border); box-shadow: 0 0 15px var(--p4-border); }
        .p5 { background: rgba(51,26,0,0.9); border-color: var(--p5-border); box-shadow: 0 0 15px var(--p5-border); }
        .p6 { background: rgba(0,51,51,0.9); border-color: var(--p6-border); box-shadow: 0 0 15px var(--p6-border); }
        
        .shows { background: rgba(43,29,0,0.9); border-color: var(--shows-border); box-shadow: 0 0 15px var(--shows-border); }
        .movie { background: var(--movie-bg); border-color: var(--movie-border); box-shadow: 0 0 8px var(--movie-border); }
        
        .postcredit { 
            width: 220px;
            background: var(--postcredit-bg); 
            border: 2px dashed var(--postcredit-border); 
            box-shadow: 0 0 8px var(--postcredit-border); 
        }

        /* SVG Paths */
        path { fill: none; stroke-width: 2px; opacity: 0.7; }
        .connection-line { stroke-dasharray: 10; stroke-dashoffset: 1000; animation: dash 60s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: 0; } }

        /* --- UI Controls Layer --- */
        .ui-layer {
            position: fixed; z-index: 1000;
            width: 100%; height: 100%;
            top: 0; left: 0; pointer-events: none;
        }

        /* --- Draggable Legend --- */
        .legend-widget {
            position: absolute;
            top: 20px; left: 20px;
            width: 320px;
            max-width: 90vw;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8), 0 0 15px rgba(226, 54, 54, 0.2);
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .legend-header {
            background: #1a0505;
            border-bottom: 1px solid var(--core-red);
            padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: move; 
            color: var(--core-red);
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            white-space: nowrap;
            user-select: none;
        }

        .legend-header span.title { pointer-events: none; }

        .minimize-btn {
            background: transparent; color: white; border: 1px solid #666;
            width: 26px; height: 26px; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-family: monospace; font-weight: bold; font-size: 16px;
        }
        .minimize-btn:hover { background: #333; }

        .legend-body {
            padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
        }

        .legend-widget.minimized .legend-body { display: none; }

        .legend-item { display: flex; align-items: center; font-size: 13px; color: #ddd; white-space: nowrap; }
        .dot { width: 14px; height: 14px; margin-right: 12px; border: 1px solid #fff; border-radius: 3px; flex-shrink:0; }

        .instructions {
            margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 12px; color: #aaa; line-height: 1.5;
            display: block; 
        }
        .instructions ul { 
            padding-left: 20px; 
            margin: 5px 0 0 0; 
            display: block;
            list-style-type: disc;
        }
        .instructions li { display: list-item; text-align: left; margin-bottom: 3px; }

        /* Zoom/Center Controls */
        .controls {
            position: absolute; bottom: 25px; right: 25px;
            display: flex; flex-direction: column; gap: 12px;
            pointer-events: auto;
        }

        .btn {
            background: rgba(15, 15, 15, 0.9); color: white;
            border: 1px solid var(--core-red); padding: 14px 18px;
            font-size: 18px; cursor: pointer; border-radius: 8px;
            font-family: var(--font-family); font-weight: bold;
            box-shadow: 0 0 10px rgba(226, 54, 54, 0.4);
            backdrop-filter: blur(5px);
        }
        .btn:active { transform: scale(0.95); background: var(--core-red); }

        @media (max-width: 768px) {
            .controls { flex-direction: row; right: 15px; bottom: 15px; }
            .legend-widget { width: 280px; left: 15px; top: 15px;}
            .node { width: 230px; }
            .core-hub { width: 260px; height: 260px; min-width: 260px; min-height: 260px; }
            .core-hub h1 { font-size: 18px; }
        }
    </style>
</head>
<body>

    <div class="ui-layer">
        <div class="legend-widget" id="legend">
            <div class="legend-header" id="legend-header">
                <span class="title">S.H.I.E.L.D. Database</span>
                <button class="minimize-btn" id="min-btn">−</button>
            </div>
            <div class="legend-body">
                <div class="legend-item"><div class="dot" style="background:var(--p1-bg); border-color:var(--p1-border);"></div>Phase 1 (Space)</div>
                <div class="legend-item"><div class="dot" style="background:var(--p2-bg); border-color:var(--p2-border);"></div>Phase 2 (Reality)</div>
                <div class="legend-item"><div class="dot" style="background:var(--p3-bg); border-color:var(--p3-border);"></div>Phase 3 (Time)</div>
                <div class="legend-item"><div class="dot" style="background:var(--p4-bg); border-color:var(--p4-border);"></div>Phase 4 (Multiverse)</div>
                <div class="legend-item"><div class="dot" style="background:var(--p5-bg); border-color:var(--p5-border);"></div>Phase 5 (Doomsday Build)</div>
                <div class="legend-item"><div class="dot" style="background:var(--p6-bg); border-color:var(--p6-border);"></div>Phase 6 (Secret Wars)</div>
                <div class="legend-item"><div class="dot" style="background:var(--shows-bg); border-color:var(--shows-border);"></div>Disney+ Series</div>
                <div class="legend-item"><div class="dot" style="background:var(--postcredit-bg); border-color:var(--postcredit-border); border-style:dashed;"></div>Post-Credit / Plot Setup</div>
                
                <div class="instructions">
                    <strong>Navigation:</strong>
                    <ul>
                        <li><strong>Drag</strong> background to pan</li>
                        <li><strong>Pinch/Scroll</strong> to zoom</li>
                        <li><strong>Click</strong> nodes to expand</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="adjustZoom(0.2)">+</button>
            <button class="btn" onclick="adjustZoom(-0.2)">−</button>
            <button class="btn" onclick="resetView()">⟲ Center</button>
        </div>
    </div>

    <!-- Interactive Canvas -->
    <div id="viewport">
        <div id="world">
            <div id="stars"></div>
            <svg id="connections"></svg>
            <div id="nodes-container"></div>
        </div>
    </div>

<script>
/* ---------------- COMPREHENSIVE MCU DATA (6 PHASES) ---------------- */
const mcuData = {
    id: "core", type: "core", title: "Marvel Cinematic<br>Universe",
    children: [
        // PHASE 1
        { id: "p1", type: "phase", styleClass: "p1", title: "Phase 1<br>Avengers Assembled", children: [
            { id: "m1", type: "sub", styleClass: "movie p1", title: "Iron Man", details: ["Tony Stark", "Arc Reactor"], children: [
                { id: "c1", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Nick Fury discusses the Avenger Initiative"] }]},
            { id: "m2", type: "sub", styleClass: "movie p1", title: "The Incredible Hulk", details: ["Bruce Banner", "Abomination"], children: [
                { id: "c2", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Tony Stark tells Ross: 'We're putting a team together'"] }]},
            { id: "m3", type: "sub", styleClass: "movie p1", title: "Iron Man 2", details: ["War Machine", "Black Widow"], children: [
                { id: "c3", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Coulson finds Mjolnir in New Mexico"] }]},
            { id: "m4", type: "sub", styleClass: "movie p1", title: "Thor", details: ["Asgard", "Loki's Scheme"], children: [
                { id: "c4", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Selvig meets Fury; Loki controls Selvig's mind"] }]},
            { id: "m5", type: "sub", styleClass: "movie p1", title: "Captain America: TFA", details: ["Steve Rogers", "The Tesseract"], children: [
                { id: "c5", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Steve wakes up in modern-day Times Square"] }]},
            { id: "m6", type: "sub", styleClass: "movie p1", title: "The Avengers", details: ["Battle of NY", "Avengers Unite"], children: [
                { id: "c6", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Thanos smiles: 'To challenge them is to court death'"] }]}
        ]},
        
        // PHASE 2
        { id: "p2", type: "phase", styleClass: "p2", title: "Phase 2<br>Age of Miracles", children: [
            { id: "m7", type: "sub", styleClass: "movie p2", title: "Iron Man 3", details: ["Extremis", "Clean Slate Protocol"], children: [
                { id: "c7", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Tony treats Bruce Banner as a therapist"] }]},
            { id: "m8", type: "sub", styleClass: "movie p2", title: "Thor: The Dark World", details: ["Reality Stone", "Malekith"], children: [
                { id: "c8", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Volstagg gives Aether to The Collector"] }]},
            { id: "m9", type: "sub", styleClass: "movie p2", title: "Captain America: TWS", details: ["Fall of SHIELD", "Winter Soldier"], children: [
                { id: "c9", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Strucker shows the Twins (Wanda & Pietro)"] }]},
            { id: "m10", type: "sub", styleClass: "movie p2", title: "Guardians of the Galaxy", details: ["Power Stone", "Star-Lord"], children: [
                { id: "c10", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Howard the Duck drinks with The Collector"] }]},
            { id: "m11", type: "sub", styleClass: "movie p2", title: "Avengers: Age of Ultron", details: ["Ultron", "Sokovia"], children: [
                { id: "c11", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Thanos grabs the Gauntlet: 'Fine, I'll do it myself'"] }]},
            { id: "m12", type: "sub", styleClass: "movie p2", title: "Ant-Man", details: ["Scott Lang", "Pym Particles"], children: [
                { id: "c12", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Falcon and Cap find Bucky; mention 'a guy' (Ant-Man)"] }]}
        ]},

        // PHASE 3
        { id: "p3", type: "phase", styleClass: "p3", title: "Phase 3<br>The Infinity Saga", children: [
            { id: "m13", type: "sub", styleClass: "movie p3", title: "Civil War", details: ["Sokovia Accords", "Team Cap vs Iron"], children: [
                { id: "c13", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Bucky in Wakanda cryo; Spidey signal"] }]},
            { id: "m14", type: "sub", styleClass: "movie p3", title: "Doctor Strange", details: ["Time Stone", "Dormammu"], children: [
                { id: "c14", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Strange helps Thor find Odin"] }]},
            { id: "m15", type: "sub", styleClass: "movie p3", title: "GotG Vol. 2", details: ["Ego", "Yondu's Death"], children: [
                { id: "c15", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Adam Warlock cocoon revealed"] }]},
            { id: "m16", type: "sub", styleClass: "movie p3", title: "Spider-Man: Homecoming", details: ["Vulture", "Stark Internship"], children: [
                { id: "c16", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Vulture protects Peter's ID in prison"] }]},
            { id: "m17", type: "sub", styleClass: "movie p3", title: "Thor: Ragnarok", details: ["Hela", "Asgard Destroyed"], children: [
                { id: "c17", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Thanos' ship Sanctuary II intercepts the Ark"] }]},
            { id: "m18", type: "sub", styleClass: "movie p3", title: "Black Panther", details: ["Killmonger", "Wakanda Open"], children: [
                { id: "c18", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Bucky (White Wolf) healed in Wakanda"] }]},
            { id: "m19", type: "sub", styleClass: "movie p3", title: "Infinity War", details: ["The Snap", "Thanos Wins"], children: [
                { id: "c19", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Fury pages Captain Marvel before dusting"] }]},
            { id: "m20", type: "sub", styleClass: "movie p3", title: "Ant-Man & The Wasp", details: ["Quantum Realm", "Ghost"], children: [
                { id: "c20", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Pym family dusts; Scott trapped in Quantum Realm"] }]},
            { id: "m21", type: "sub", styleClass: "movie p3", title: "Captain Marvel", details: ["Kree/Skrull War", "Tesseract"], children: [
                { id: "c21", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Carol appears at Avengers HQ: 'Where's Fury?'"] }]},
            { id: "m22", type: "sub", styleClass: "movie p3", title: "Avengers: Endgame", details: ["Time Heist", "Tony's Snap"], children: [
                { id: "c22", type: "side", styleClass: "postcredit", title: "Lore", details: ["Sound of Tony Stark forging the first armor (Legacy)"] }]},
            { id: "m23", type: "sub", styleClass: "movie p3", title: "Far From Home", details: ["Mysterio", "EDITH"], children: [
                { id: "c23", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["J. Jonah Jameson reveals Spider-Man is Peter Parker"] }]}
        ]},

        // PHASE 4
        { id: "p4", type: "phase", styleClass: "p4", title: "Phase 4<br>The Multiverse Begins", children: [
            { id: "m24", type: "sub", styleClass: "movie shows", title: "WandaVision", details: ["Westview", "Scarlet Witch"], children: [
                { id: "c24", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Wanda hears her children while reading the Darkhold"] }]},
            { id: "m25", type: "sub", styleClass: "movie shows", title: "Falcon & Winter Soldier", details: ["Sam is Cap", "Power Broker"], children: [
                { id: "c25", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Sharon Carter pardoned; selling secrets"] }]},
            { id: "m26", type: "sub", styleClass: "movie shows", title: "Loki S1", details: ["He Who Remains", "Timeline Breaks"], children: [
                { id: "c26", type: "side", styleClass: "postcredit", title: "Lore", details: ["Loki lands in a Kang-ruled TVA"] }]},
            { id: "m27", type: "sub", styleClass: "movie p4", title: "Black Widow", details: ["Red Room", "Yelena"], children: [
                { id: "c27", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Val targets Hawkeye for Yelena"] }]},
            { id: "m29", type: "sub", styleClass: "movie p4", title: "Shang-Chi", details: ["Ten Rings", "Dweller in Darkness"], children: [
                { id: "c29", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Beacon signal detected from the Rings"] }]},
            { id: "m30", type: "sub", styleClass: "movie p4", title: "Eternals", details: ["Emergence Stopped", "Arishem"], children: [
                { id: "c30", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Eros (Starfox) arrives to help"] }]},
            { id: "m32", type: "sub", styleClass: "movie p4", title: "No Way Home", details: ["3 Spideys", "Memory Wipe"], children: [
                { id: "c32", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Venom leaves a Symbiote piece in MCU"] }]},
            { id: "m34", type: "sub", styleClass: "movie p4", title: "Doctor Strange 2", details: ["Incursions", "Wanda's Rampage"], children: [
                { id: "c34", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Clea recruits Strange to fix Incursions"] }]},
            { id: "m36", type: "sub", styleClass: "movie p4", title: "Love and Thunder", details: ["Gorr", "Jane's Death"], children: [
                { id: "c36", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Zeus sends Hercules to kill Thor"] }]},
            { id: "m38", type: "sub", styleClass: "movie p4", title: "Wakanda Forever", details: ["Namor", "Shuri is BP"], children: [
                { id: "c38", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Shuri meets T'Challa's son"] }]}
        ]},

        // PHASE 5
        { id: "p5", type: "phase", styleClass: "p5", title: "Phase 5<br>Doomsday Build", children: [
            { id: "m39", type: "sub", styleClass: "movie p5", title: "Ant-Man: Quantumania", details: ["Kang", "Microverse"], children: [
                { id: "c39", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Council of Kangs gathers; Victor Timely intro"] }]},
            { id: "m40", type: "sub", styleClass: "movie p5", title: "GotG Vol. 3", details: ["Rocket's Origin", "High Evo"], children: [
                { id: "c40", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["New Guardians Team formed; Quill on Earth"] }]},
            { id: "m41", type: "sub", styleClass: "movie shows", title: "Secret Invasion", details: ["Super Skrulls", "Harvest"], children: [
                { id: "c41", type: "side", styleClass: "postcredit", title: "Lore", details: ["President declares war on aliens"] }]},
            { id: "m42", type: "sub", styleClass: "movie shows", title: "Loki S2", details: ["Yggdrasil", "God Loki"], children: [
                { id: "c42", type: "side", styleClass: "postcredit", title: "Lore", details: ["Loki holds the multiverse together"] }]},
            { id: "m43", type: "sub", styleClass: "movie p5", title: "The Marvels", details: ["Quantum Bands", "Incursion"], children: [
                { id: "c43", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["Monica stranded in X-Men Universe (Beast/Binary)"] }]},
            { id: "m46", type: "sub", styleClass: "movie p5", title: "Deadpool & Wolverine", details: ["Anchor Beings", "The Void"], children: [
                { id: "c46", type: "side", styleClass: "postcredit", title: "Post-Credit", details: ["TVA monitoring Earth-10005 Anchor Being"] }]},
            { id: "m47", type: "sub", styleClass: "movie shows", title: "Agatha All Along", details: ["Wiccan", "Death"], children: [
                { id: "c47", type: "side", styleClass: "postcredit", title: "Lore", details: ["Agatha guides Billy to find Tommy"] }]},
            { id: "m48", type: "sub", styleClass: "movie p5", title: "Cap: Brave New World", details: ["Red Hulk", "Adamantium"], children: [
                { id: "c48", type: "side", styleClass: "postcredit", title: "Plot Setup", details: ["Tiamut (Celestial) is source of Adamantium; Leader schemes"] }]},
            { id: "m49", type: "sub", styleClass: "movie shows", title: "Daredevil: Born Again", details: ["Mayor Fisk", "Street Level"], children: [
                { id: "c49", type: "side", styleClass: "postcredit", title: "Plot Setup", details: ["Fisk outlaws vigilantes; Punisher returns"] }]},
            { id: "m50", type: "sub", styleClass: "movie p5", title: "Thunderbolts*", details: ["Val's Team", "Sentry"], children: [
                { id: "c50", type: "side", styleClass: "postcredit", title: "Plot Setup", details: ["Val buys Avengers Tower; Sentry (Bob) is the weapon"] }]},
            { id: "m51", type: "sub", styleClass: "movie shows", title: "Ironheart", details: ["Magic vs Tech", "The Hood"], children: [
                { id: "c51", type: "side", styleClass: "postcredit", title: "Plot Setup", details: ["Mephisto technology trade; Armor Wars setup"] }]},
            { id: "m52", type: "sub", styleClass: "movie shows", title: "Wonder Man", details: ["Hollywood", "Grim Reaper"], children: [
                { id: "c52", type: "side", styleClass: "postcredit", title: "Plot Setup", details: ["Simon Williams gains ionic powers"] }]}
        ]},

        // PHASE 6
        { id: "p6", type: "phase", styleClass: "p6", title: "Phase 6<br>The Multiverse Finale", children: [
            { id: "m53", type: "sub", styleClass: "movie p6", title: "Fantastic Four: First Steps", details: ["Galactus", "Future Foundation"], children: [
                { id: "c53", type: "side", styleClass: "postcredit", title: "Plot Setup", details: ["Set in alternate 60s; Bridge to 616; Doom's rise"] }]},
            { id: "m54", type: "sub", styleClass: "movie p6", title: "Avengers: Doomsday", details: ["Doctor Doom", "Incursions"], children: [
                { id: "c54", type: "side", styleClass: "postcredit", title: "Lore", details: ["Collapse of the Multiverse begins"] }]},
            { id: "m55", type: "sub", styleClass: "movie p6", title: "Spider-Man 4", details: ["Symbiote?", "Street Level"], children: [
                { id: "c55", type: "side", styleClass: "postcredit", title: "Lore", details: ["Peter plays key role in Incursion defense"] }]},
            { id: "m56", type: "sub", styleClass: "movie p6", title: "Avengers: Secret Wars", details: ["Battleworld", "Soft Reboot"], children: [
                { id: "c56", type: "side", styleClass: "postcredit", title: "Lore", details: ["Creation of a new, single Sacred Timeline (Mutants included)"] }]}
        ]}
    ]
};

/* ---------------- LAYOUT CONSTANTS ---------------- */
const CENTER_X = 3000;
const CENTER_Y = 3000;
const PHASE_RADIUS = 400;     
const SUB_RADIUS_MIN = 800;   
const SUB_RADIUS_MAX = 1000;  
const LEAF_RADIUS = 220;      

const world = document.getElementById('world');
const svgContainer = document.getElementById('connections');
const container = document.getElementById('nodes-container');
let renderedNodes = {};

/* ---------------- RENDERING ENGINE ---------------- */
function init() {
    renderTree(mcuData, CENTER_X, CENTER_Y, 0, 360, 0);
    drawConnections();
    resetView();
    setupMapInteractions();
    setupLegendInteractions();
}

function renderTree(node, parentX, parentY, startAngle, endAngle, depth, childIndex = 0) {
    let x, y, currentAngle;

    if (depth === 0) {
        x = CENTER_X; y = CENTER_Y;
    } else if (depth === 1) {
        // 6 Phases distributed
        const phaseAngles = { 'p1': 270, 'p2': 330, 'p3': 30, 'p4': 90, 'p5': 150, 'p6': 210 };
        let angleDeg = phaseAngles[node.id];
        const rad = (angleDeg * Math.PI) / 180;
        x = CENTER_X + PHASE_RADIUS * Math.cos(rad);
        y = CENTER_Y + PHASE_RADIUS * Math.sin(rad);
        currentAngle = angleDeg;
    } else if (depth === 2) {
        // Movies
        const span = 60; 
        const step = span / node.siblingsCount;
        const phaseStart = startAngle - (span / 2);
        currentAngle = phaseStart + (step * childIndex) + (step / 2);
        
        const dist = (childIndex % 2 === 0) ? SUB_RADIUS_MIN : SUB_RADIUS_MAX;
        const rad = (currentAngle * Math.PI) / 180;
        x = parentX + dist * Math.cos(rad);
        y = parentY + dist * Math.sin(rad);
    } else {
        // Post-credits
        currentAngle = startAngle + (childIndex * 15) - 7.5; 
        const rad = (currentAngle * Math.PI) / 180;
        x = parentX + LEAF_RADIUS * Math.cos(rad);
        y = parentY + LEAF_RADIUS * Math.sin(rad);
    }

    const el = document.createElement('div');
    const isCore = node.type === 'core';
    el.className = `node ${node.styleClass || ''} ${isCore ? 'core-hub' : ''}`;
    
    let html = `<h3>${node.title}</h3>`;
    if (node.details && node.details.length > 0) {
        html += `<ul>${node.details.map(d => `<li>${d}</li>`).join('')}</ul>`;
    }
    el.innerHTML = html;

    // Use specific left/top based on center point and let CSS transform handle centering
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.dataset.id = node.id;
    el.dataset.expanded = "true";
    el.style.zIndex = depth * 10;

    el.addEventListener('pointerdown', (e) => e.stopPropagation());
    el.onclick = (e) => {
        if(mapState.isDragging) return; 
        toggleNode(node.id);
    };

    container.appendChild(el);
    renderedNodes[node.id] = { x, y, el, children: [], color: getComputedStyle(el).borderColor };

    if (node.children) {
        node.children.forEach((child, idx) => {
            child.siblingsCount = node.children.length;
            renderedNodes[node.id].children.push(child.id);
            renderTree(child, x, y, currentAngle, 0, depth + 1, idx);
        });
    }
}

function drawConnections() {
    svgContainer.innerHTML = "";
    Object.keys(renderedNodes).forEach(id => {
        const node = renderedNodes[id];
        node.children.forEach(childId => {
            const child = renderedNodes[childId];
            if (child.el.style.display !== 'none') {
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const midX = (node.x + child.x) / 2;
                const midY = (node.y + child.y) / 2;
                const d = `M ${node.x} ${node.y} Q ${midX} ${midY} ${child.x} ${child.y}`;
                
                path.setAttribute("d", d);
                path.setAttribute("stroke", child.color);
                path.setAttribute("class", "connection-line");
                if(child.el.classList.contains('postcredit')) path.setAttribute("stroke-dasharray", "6,6");
                svgContainer.appendChild(path);
            }
        });
    });
}

function toggleNode(id) {
    const node = renderedNodes[id];
    const isExpanded = node.el.dataset.expanded === "true";
    node.el.dataset.expanded = isExpanded ? "false" : "true";
    node.el.classList.toggle('expanded');
    
    function setVis(pid, visible) {
        renderedNodes[pid].children.forEach(cid => {
            const child = renderedNodes[cid];
            child.el.style.display = visible ? 'flex' : 'none';
            if(visible && child.el.dataset.expanded === "true") setVis(cid, true);
            else if(!visible) setVis(cid, false);
        });
    }
    setVis(id, !isExpanded);
    drawConnections();
}

/* ---------------- INTERACTION ENGINE ---------------- */
function setupLegendInteractions() {
    const legend = document.getElementById('legend');
    const header = document.getElementById('legend-header');
    const minBtn = document.getElementById('min-btn');
    let isDraggingLeg = false, startX, startY, initLeft, initTop;

    header.addEventListener('pointerdown', (e) => {
        if(e.target === minBtn) return;
        isDraggingLeg = true;
        startX = e.clientX; startY = e.clientY;
        const rect = legend.getBoundingClientRect();
        initLeft = rect.left; initTop = rect.top;
        legend.style.right = 'auto'; legend.style.bottom = 'auto';
        e.stopPropagation();
    });

    window.addEventListener('pointermove', (e) => {
        if (!isDraggingLeg) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        let newX = Math.max(0, Math.min(initLeft + dx, window.innerWidth - legend.offsetWidth));
        let newY = Math.max(0, Math.min(initTop + dy, window.innerHeight - legend.offsetHeight));
        legend.style.left = `${newX}px`; legend.style.top = `${newY}px`;
        e.stopPropagation();
    });

    window.addEventListener('pointerup', () => isDraggingLeg = false);
    minBtn.addEventListener('click', (e) => {
        legend.classList.toggle('minimized');
        minBtn.textContent = legend.classList.contains('minimized') ? '+' : '−';
        e.stopPropagation();
    });
    legend.addEventListener('pointerdown', e => e.stopPropagation());
    legend.addEventListener('wheel', e => e.stopPropagation());
}

let mapState = { x: 0, y: 0, scale: 1, isDragging: false };
const MIN_SCALE = 0.08, MAX_SCALE = 2.5;
const viewport = document.getElementById('viewport');
let evCache = [];
let prevDiff = -1;

function setupMapInteractions() {
    viewport.addEventListener('pointerdown', e => { evCache.push(e); mapState.isDragging = true; });
    viewport.addEventListener('pointermove', e => {
        const index = evCache.findIndex(ev => ev.pointerId === e.pointerId);
        if(index > -1) evCache[index] = e;
        if (!mapState.isDragging) return;
        if (evCache.length === 2) {
            const curDiff = Math.hypot(evCache[0].clientX - evCache[1].clientX, evCache[0].clientY - evCache[1].clientY);
            if (prevDiff > 0) {
                const centerX = (evCache[0].clientX + evCache[1].clientX) / 2;
                const centerY = (evCache[0].clientY + evCache[1].clientY) / 2;
                zoomToPoint(centerX, centerY, (curDiff - prevDiff) * 0.004);
            }
            prevDiff = curDiff;
        } else if (evCache.length === 1) {
            mapState.x += e.movementX; mapState.y += e.movementY; updateTransform();
        }
    });

    const pointerUpHandler = e => {
        const index = evCache.findIndex(ev => ev.pointerId === e.pointerId);
        if(index > -1) evCache.splice(index, 1);
        if (evCache.length < 2) prevDiff = -1;
        if (evCache.length === 0) setTimeout(() => mapState.isDragging = false, 50);
    };
    viewport.addEventListener('pointerup', pointerUpHandler);
    viewport.addEventListener('pointercancel', pointerUpHandler);
    viewport.addEventListener('pointerout', pointerUpHandler);
    viewport.addEventListener('wheel', e => { e.preventDefault(); zoomToPoint(e.clientX, e.clientY, -e.deltaY * 0.001); }, { passive: false });
}

function zoomToPoint(cx, cy, factor) {
    const newScale = Math.min(Math.max(mapState.scale + factor, MIN_SCALE), MAX_SCALE);
    const scaleRatio = newScale / mapState.scale;
    mapState.x = cx - (cx - mapState.x) * scaleRatio;
    mapState.y = cy - (cy - mapState.y) * scaleRatio;
    mapState.scale = newScale;
    updateTransform();
}

function adjustZoom(amount) { zoomToPoint(window.innerWidth / 2, window.innerHeight / 2, amount); }
function updateTransform() { world.style.transform = `translate(${mapState.x}px, ${mapState.y}px) scale(${mapState.scale})`; }
function resetView() {
    const winW = window.innerWidth;
    let initialScale = winW < 768 ? 0.35 : 0.6; 
    mapState.x = (winW / 2) - (CENTER_X * initialScale);
    mapState.y = (window.innerHeight / 2) - (CENTER_Y * initialScale);
    mapState.scale = initialScale;
    updateTransform();
}

window.onload = init;
</script>
</body>
</html>
